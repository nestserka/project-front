<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- <link href="/css/my.css" rel="stylesheet"> -->
    <link href="../css/my.css" rel="stylesheet">
    <link rel="icon" href="../resources/favicon.ico">
    <title>Document</title>
</head>
<body>
<header class="header">
    <h1>RPG admin panel</h1>
    <nav class="nav">
        <ul class="nav-list">
          <li class="nav-item"><a href="#about" class="nav-link">About</a></li>
          <li class="nav-item"><a href="#accountlist" class="nav-link">Account List</a></li>
          <li class="nav-item"><a href="#registration" class="nav-link">Registration form</a></li>
        </ul>
      </nav>
</header>
<main class="main">
    <section class="section" id="about">
        <div class="text_wrapper"> 
          <h2 class="about">S Meneg suilaid!</h2>
          <h3>Do Not Be Afraid, Mithrandir <br> You Are Not Alone</h3>
          <h4> &#169 J. R. R. Tolkien</h4>
          </div>
        </div>
    </section>
    <section class="section" id="accountlist">
    <h2>Account List</h2>
    <hr>
    <div class="tab_head_containter">
        <div class="page_limit">
            <span>Count per page</span>
            <select name="" id="table_size">
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
            </select>
        </div>
    </div>
    <div class="container">
        <table id="players">
            <thead>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Title</th>
                <th>Race</th>
                <th>Profession</th>
                <th>Level</th>
                <th>Birthday</th>
                <th>Banned</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
            </thead>
        </table>
    </div>
    <div class="footer">
        <span></span>
        <div class="index_buttons"></div>
    </div>
</section>
<section class="section" id="registration">
        <h3>Registation form</h3>
        <hr>
        <div class="registation_form"> 
        <form class="form">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" maxlength="12" placeholder="Name" pattern="[A-Za-z-]+"/>

            <label for="title">Title</label>
            <input type="text" id="title" name="title" maxlength="30" placeholder="Title" pattern="[A-Za-z-]+" />

            <label for="race">Race</label>
            <select name="race" id="race">
                <option value="HUMAN">HUMAN</option>
                <option value="DWARF">DWARF</option>
                <option value="ELF">ELF</option>
                <option value="GIANT">GIANT</option>
                <option value="ORC">ORC</option>
                <option value="TROLL">TROLL</option>
                <option value="HOBBIT">HOBBIT</option>
            </select>

            <label for="profession">Profession</label>
            <select name="profession" id="profession">
                <option value="WARRIOR">WARRIOR</option>
                <option value="ROGUE">ROGUE</option>
                <option value="SORCERER">SORCERER</option>
                <option value="CLERIC">CLERIC</option>
                <option value="PALADIN">PALADIN</option>
                <option value="NAZGUL">NAZGUL</option>
                <option value="WARLOCK">WARLOCK</option>
                <option value="DRUID">DRUID</option>
            </select>

            <label for="level">Level</label>
            <input type="number" id="level" name="level" placeholder="25" min="0" max="100" />

            <label for="date">Birthday</label>
            <input type="date"
                   id="date"
                   max="2077-06-20"
                   min="1920-06-05"
                   value="2023-07-20">
            <label for="banned">Banned</label>
            <select name="banned" id="banned">
                <option value="false">false</option>
                <option value="true">true</option>
            </select>
            <button class="submit-button" type="submit">Submit</button>
        </form>
    </div>
</section>
</main>

<footer>
    <ul class="contact-list">
        <li class="footer-item-list">
            <a href="https://github.com/nestserka">
                <img src= "../img/github.svg" alt="github">
              </a>
          </li>
        <li class="footer-item-list"><a href="#" class="footer-item-list"> &copy;2023</a></li>
      </ul>
</footer>
<!-- Js -->
<!-- <script src="/js/app.js"></script> -->
<script>

    let array_length =  parseInt($("#array_length").val());
    let table_size = parseInt($("#table_size").val());
    var start_index = 1;
    var end_index = 10;
    var current_index = 1;
    var max_index = 10;
    const editIconURL = "../img/edit.svg";
    const deleteIconURL = "../img/delete.svg";
    const saveIconUrl = "../img/save.svg";


    $(document).ready(function() {
        $.ajax({
            method: "GET",
            url: "/rest/players",
            dataType: "json",
            success: function (response) {
                console.log(response);
                $.each(response, function (key, value) {
                    let birthdayDate = new Date(value.birthday);
                    let formattedBirthday = birthdayDate.toLocaleDateString("en-GB");
                    $('#players').append("<tr>\
										<td>" + value.id + "</td>\
										<td>" + value.name + "</td>\
										<td>" + value.title + "</td>\
										<td>" + value.race + "</td>\
										<td>" + value.profession + "</td>\
										<td>" + value.level + "</td>\
										<td>" + formattedBirthday + "</td>\
										<td>" + value.banned + "</td>\
										<td>\
                              <button class='edit-button' onclick='handleEditAccount(this)'><img src='" + editIconURL + "' alt='edit' style='width: 24px; height: 24px; cursor: pointer;'></button>\
                              <button class='save-button' style='display: none;'><img src='" + saveIconUrl + "' alt='save' style='width: 24px; height: 24px; cursor: pointer;'></button>\
                            </td>\
                            <td><button class='delete-button' onclick='handleDeleteClick(" + value.id + ")'><img src='" + deleteIconURL + "' alt='delete' style='width: 24px; height: 24px; cursor: pointer;'></button></td>\
                            </tr>");
                })
            }

        });

        let getPlayersCount = () => {
            return $.ajax({
                method: "GET",
                url: "/rest/players/count",
                dataType: "json"
            });
        };

        getPlayersCount()
            .then(data => {
                array_length = parseInt(data);
                displayIndexOfButtons(array_length)
                console.log("Player count:", array_length);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                throw error;
            });
    });


    function preLoadCalculations(array_length){
        max_index = Math.floor(array_length / table_size);
        console.log(max_index);
        if ((array_length % table_size) >0){
            max_index++;
        }
    }


    function displayIndexOfButtons(array_length){
        preLoadCalculations(array_length)
        $(".index_buttons button").remove()
        $(".index_buttons").append('<button onclick="prev();">Previous</button>')

        for (var i=1; i<=max_index; i++) {
            $(".index_buttons").append('<button onclick="indexPagination('+i+');" index="'+i+'">'+i+'</button>')
        }
        $(".index_buttons").append('<button onclick="next();">Next</button>');
        highlightIndexButton();

    }


    function highlightIndexButton(){
        start_index = ((current_index -1) * table_size +1);
        end_index = (start_index + table_size)  -1;
        if (end_index > array_length){
            end_index = array_length;
        }

        $(".footer span").text('Showing '+start_index+' to '+end_index+' of '+array_length+' entries');
        $(".index_buttons button").removeClass('active')
        $(".index_buttons button[index='"+current_index+"']").addClass('active');

    }

    displayIndexOfButtons();

    function next(){
        if (current_index < max_index){
            current_index++;
            highlightIndexButton();
            getUsersWithPagination(current_index, table_size);
        }
    }

    function prev(){
        if (current_index >1){
            current_index--;
            highlightIndexButton();
            getUsersWithPagination(current_index, table_size);
        }
    }

    function indexPagination(index){
        current_index = parseInt(index);
        highlightIndexButton();
        getUsersWithPagination(current_index, table_size);
    }

    $("#table_size").change(function(){
        table_size = parseInt($(this).val());
        current_index = 1;
        start_index = 1;
        displayIndexOfButtons(array_length);
        getUsersWithPagination(current_index, table_size);
    });

    function getUsersWithPagination(pageNumber, pageSize) {
        $.ajax({
            method: "GET",
            url: "/rest/players",
            data: {
                pageNumber: pageNumber-1,
                pageSize: pageSize
            },
            dataType: "json",
            success: function(response) {
                $('#players').empty();
                $.each(response, function(key, value) {
                    let birthdayDate = new Date(value.birthday);
                    let formattedBirthday = birthdayDate.toLocaleDateString("en-GB");
                    $('#players').append("<tr>\
                              <td>" + value.id + "</td>\
                              <td>" + value.name + "</td>\
                              <td>" + value.title + "</td>\
                              <td>" + value.race + "</td>\
                              <td>" + value.profession + "</td>\
                              <td>" + value.level + "</td>\
                              <td>" + formattedBirthday + "</td>\
                              <td>" + value.banned + "</td>\
                              <td>\
                              <button class='edit-button' onclick='handleEditAccount(this)'><img src='" + editIconURL + "' alt='edit' style='width: 24px; height: 24px; cursor: pointer;'></button>\
                              <button class='save-button' style='display: none;'><img src='" + saveIconUrl + "' alt='save' style='width: 24px; height: 24px; cursor: pointer;'></button>\
                            </td>\
                            <td><button class='delete-button' onclick='handleDeleteClick(" + value.id + ")'><img src='" + deleteIconURL + "' alt='delete' style='width: 24px; height: 24px; cursor: pointer;'></button></td>\
                            </tr>");
                });
            },
            error: function(error) {
                console.error("Error fetching users:", error);
            }
        });
    }

    function handleDeleteClick(id){
        $.ajax({
            url: '/rest/players/' + id,
            method: 'DELETE',
            contentType: 'application/json',
            success: function(result) {
                getUsersWithPagination(current_index, table_size)
            },
            error: function(jqXHR, textStatus, errorThrown) {
                if (jqXHR.status === 404) {
                    alert("Player not found with ID:", id);
                } else if (jqXHR.status === 400) {
                    alert("Invalid ID value:", id);
                } else {
                    alert("Error deleting user:", errorThrown);
                }
            }
        });
    }

    function handleEditAccount(button) {
        let row = $(button).closest('tr');

        row.find('.edit-button').hide();
        row.find('.save-button').show();

    }



    $(document).on('click', '.edit-button', function () {
        handleEditAccount(this);
    });

    $('form').submit(function (e) {
        e.preventDefault();

        let name = $('#name').val();
        let title = $('#title').val();
        let race = $('#race').val();
        let profession = $('#profession').val();
        let birthday = $('#date').val();
        let banned = $('#banned').val();
        let level = parseInt($('#level').val(), 10);
        let birthdayTimestamp = new Date(birthday).getTime();

        if (!name || !title || !race || !profession || !birthday || banned === null || banned === "") {
            const errorMessage = "One or more required fields are empty.";
            console.error(errorMessage);
            throw new Error(errorMessage);
        }

        if (name.length === 1 || title.length === 1) {
            alert("Name and title must contain more than one character.");
            return;
        }
        const data = {
            name: name,
            title: title,
            race: race,
            profession: profession,
            birthday: birthdayTimestamp,
            banned: banned,
            level: level,
        };
        console.log(data);
        $.ajax({
            type: 'POST',
            url: '/rest/players',
            data: JSON.stringify(data),
            contentType: 'application/json',
        })
            .done((data) => {
                console.log({ data });
                location.reload()
            })
            .fail((xhr, status, error) => {
                console.error(error);
                if (xhr.status === 400) {
                    console.error("Error 400: Bad Request");
                }
            })
            .always(() => {
                console.log('always called');
            });
    });

    function handleEditAccount(button) {
        const row = $(button).closest('tr');
        const editButton = row.find('.edit-button');
        const saveButton = row.find('.save-button');

        if (editButton.is(':visible')) {
            row.find('td:not(:last-child)').each(function (index) {
                const fieldName = ['id', 'name', 'title', 'race', 'profession', 'level', 'birthday', 'banned'][index];
                const value = $(this).text().trim();
                if (fieldName === 'profession') {
                    const raceOptions = ['WARRIOR',
                        'ROGUE',
                        'SORCERER',
                        'CLERIC',
                        'PALADIN',
                        'NAZGUL',
                        'WARLOCK',
                        'DRUID'];
                    const options = raceOptions.map(opt => `<option value="${opt}"${value === opt ? ' selected' : ''}>${opt}</option>`).join('');
                    $(this).html(`<select class="edit-input">${options}</select>`);
                } else if (fieldName === 'race') {
                    const raceOptions = ['HUMAN',
                        'DWARF',
                        'ELF',
                        'GIANT',
                        'ORC',
                        'TROLL',
                        'HOBBIT'];
                    const options = raceOptions.map(opt => `<option value="${opt}"${value === opt ? ' selected' : ''}>${opt}</option>`).join('');
                    $(this).html(`<select class="edit-input">${options}</select>`);
                } else if (fieldName === 'banned') {
                    const bannedOptions = ['false', 'true'];
                    const options = bannedOptions.map(opt => `<option value="${opt}"${value === opt ? ' selected' : ''}>${opt}</option>`).join('');
                    $(this).html(`<select class="edit-input">${options}</select>`);
                } else if (fieldName === 'name' || fieldName === 'title') {
                    $(this).html(`<input type="text" class="edit-input" value="${value}">`);
                }
            });

            editButton.hide();
            saveButton.show();
        }
    }

        $(document).on('click', '.save-button', function () {
            const row = $(this).closest('tr');
            row.find('td:not(:last-child)').each(function (index) {
                const fieldName = ['id', 'name', 'title', 'race', 'profession', 'level', 'birthday', 'banned'][index];
                if (fieldName === 'race' || fieldName === 'banned' || fieldName === 'profession') {
                    const value = $(this).find('.edit-input').val();
                    $(this).text(value);
                } else if (fieldName === 'name' || fieldName === 'title'){
                    const value = $(this).find('.edit-input').val();
                    $(this).text(value);
                }
            });
            let findId =  row.find('td:eq(0)').text().trim();
            const editedData = {
                name: row.find('td:eq(1)').text().trim(),
                title: row.find('td:eq(2)').text().trim(),
                race: row.find('td:eq(3)').text().trim(),
                profession: row.find('td:eq(4)').text().trim(),
                banned: row.find('td:eq(7)').text().trim(),
            };
            console.log(editedData);

            $.ajax({
                method: "PUT",
                url: "/rest/players/" + findId,
                data: JSON.stringify(editedData),
                contentType: "application/json",
                success: function (response) {
                    location.reload()
                },
                error: function (xhr, status, error) {
                    console.error(error);
                },
            });
        });


</script>

</body>
</html>